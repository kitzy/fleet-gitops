- name: macOS - Enable FileVault
  platform: darwin
  description: This policy checks if FileVault (disk encryption) is enabled.
  resolution: As an IT admin, turn on disk encryption in Fleet.
  query: SELECT 1 FROM filevault_status WHERE status = 'FileVault is On.';
- name: macOS - Disable guest account
  platform: darwin
  description: This policy checks if the guest account is disabled.
  resolution: An an IT admin, deploy a macOS, login window profile with the DisableGuestAccount option set to true.
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.loginwindow' AND username = '' AND name='DisableGuestAccount' AND CAST(value AS INT) = 1;
- name: macOS - Enable Firewall
  platform: darwin
  description: This policy checks if Firewall is enabled.
  resolution: An an IT admin, deploy a macOS, Firewall profile with the EnableFirewall option set to true.
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.security.firewall' AND username = '' AND name='EnableFirewall' AND CAST(value AS INT) = 1;
- name: macOS - Require 8 character password
  platform: darwin
  description: This policy checks if the end user is required to enter a password, with at least 8 characters, to unlock the host.
  resolution: An an IT admin, deploy a macOS, screensaver profile with the askForPassword option set to true and minLength option set to 10.
  query: |
    SELECT 1 WHERE 
      EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.screensaver' AND 
            name='askForPassword' AND 
            CAST(value AS INT)
        )
      AND EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.screensaver' AND 
            name='minLength' AND 
            CAST(value AS INT) <= 8
        );
- name: macOS - Software Update baseline
  platform: darwin
  description: This policy checks if automatic updates are enabled.
  query: |
    WITH vals AS (
      SELECT
        lower(MAX(CASE WHEN key='AllowPreReleaseInstallation'       THEN value END)) AS prerelease,
        lower(MAX(CASE WHEN key='AutomaticCheckEnabled'             THEN value END)) AS check_enabled,
        lower(MAX(CASE WHEN key='AutomaticDownload'                 THEN value END)) AS auto_download,
        lower(MAX(CASE WHEN key='AutomaticallyInstallAppUpdates'    THEN value END)) AS auto_app_updates,
        lower(MAX(CASE WHEN key='AutomaticallyInstallMacOSUpdates'  THEN value END)) AS auto_macos_updates,
        lower(MAX(CASE WHEN key='ConfigDataInstall'                 THEN value END)) AS config_data,
        lower(MAX(CASE WHEN key='CriticalUpdateInstall'             THEN value END)) AS critical_updates
      FROM preferences
      WHERE domain = 'com.apple.SoftwareUpdate'
    )
    SELECT 1
    FROM vals
    WHERE prerelease         IN ('false','0')
      AND check_enabled      IN ('true','1')
      AND auto_download      IN ('true','1')
      AND auto_app_updates   IN ('true','1')
      AND auto_macos_updates IN ('false','0')
      AND config_data        IN ('true','1')
      AND critical_updates   IN ('true','1');
  resolution: An an IT admin, deploy a macOS, SoftwareUpdate profile.